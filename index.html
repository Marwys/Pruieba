<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Prueba AWS IoT + Cognito</title>

  <!-- AWS SDK -->
  <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1370.0.min.js"></script>

  <!-- AWS IoT SDK (WebSocket MQTT) -->
  <script src="https://unpkg.com/aws-iot-device-sdk/browser/aws-iot-sdk-browser-bundle.min.js"></script>

  <!-- Configuraci√≥n -->
  <script src="aws-config.js"></script>
</head>

<body>

<h2>Prueba AWS Cognito + IoT Core</h2>

<button onclick="probarCredenciales()">1Ô∏è‚É£ Probar credenciales</button>
<br><br>
<button onclick="conectarIoT()">2Ô∏è‚É£ Conectar a AWS IoT</button>

<script>
/* =========================
   PASO 1: ProBAR COGNITO
   ========================= */
function probarCredenciales() {

  console.log("üîÑ Probando credenciales Cognito...");

  AWS.config.region = awsConfig.region;

  AWS.config.credentials = new AWS.CognitoIdentityCredentials({
    IdentityPoolId: awsConfig.identityPoolId
  });

  AWS.config.credentials.get(function (err) {
    if (err) {
      console.error("‚ùå Error Cognito", err);
    } else {
      console.log("‚úÖ Credenciales obtenidas");
      console.log("AccessKey:", AWS.config.credentials.accessKeyId);
    }
  });
}

/* =========================
   PASO 2: CONECTAR A IOT
   ========================= */
function conectarIoT() {

  console.log("üîÑ Conectando a AWS IoT Core...");

  AWS.config.region = awsConfig.region;

  AWS.config.credentials = new AWS.CognitoIdentityCredentials({
    IdentityPoolId: awsConfig.identityPoolId
  });

  AWS.config.credentials.get(function (err) {
    if (err) {
      console.error("‚ùå Error Cognito", err);
      return;
    }

    console.log("‚úÖ Credenciales OK, iniciando MQTT...");

    const client = awsIot.device({
      region: awsConfig.region,
      protocol: "wss",
      host: awsConfig.iotEndpoint,

      accessKeyId: AWS.config.credentials.accessKeyId,
      secretKey: AWS.config.credentials.secretAccessKey,
      sessionToken: AWS.config.credentials.sessionToken,

      debug: true
    });

    client.on("connect", () => {
      console.log("üöÄ CONECTADO A AWS IOT CORE");
    });

    client.on("error", (err) => {
      console.error("‚ùå Error IoT", err);
    });

  });
}
</script>

</body>
</html>
